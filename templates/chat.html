{% extends "base.html" %}
{% block title %}1대1 채팅{% endblock %}

{% block content %}
<h3>{{ chat_partner.username }}님과의 채팅</h3>
<div id="chat">
  <ul id="messages"></ul>
  <input id="chat_input" type="text" placeholder="메시지를 입력하세요">
  <button onclick="sendMessage()">전송</button>
</div>

<script type="text/javascript">
  var socket;
  if (socket) {
    socket.disconnect();
  }
  socket = io('localhost:5000/chat', {
    transports: ['websocket'], // 웹소켓만 사용
    query: { room: '{{ room_id }}' }    // 서버로 전송할 추가 쿼리 파라미터
  });
  socket.on('connect', function() {
    console.log("채팅 서버에 연결됨");
    socket.emit('join_room', { 'room': "{{ room_id }}" });
  });

  socket.on('message', function(data) {
    var messages = document.getElementById('messages');
    var item = document.createElement('li');
    item.textContent = data.username + ": " + data.message;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  });

  function sendMessage() {
    var input = document.getElementById('chat_input');
    var message = input.value;
    if (message) {
      socket.emit('send_message_private', {
        'room': "{{ room_id }}",
        'username': "{{ user.username }}",
        'message': message
      });
      input.value = "";
    }
  }
</script>
{% endblock %}